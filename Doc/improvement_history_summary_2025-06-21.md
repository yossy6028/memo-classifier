# memo-classifier 改善履歴まとめ (2025-06-21時点)

## 📋 概要
memo-classifierシステムにおいて過去に発生した問題と、それに対する改善履歴をまとめました。これにより、同様の問題が再発することを防ぎ、システムの品質向上に役立てることができます。

## 🔍 主要な問題と改善点

### 1. タイトル生成・人名抽出の問題 (2025-06-21)

#### 問題の詳細
- **現象**: 「を展開中の嶋村さんへの導入内容」のように不自然なタイトルが生成される
- **原因**: 人名抽出の正規表現が貪欲マッチングで「を展開中の嶋村」全体を人名として認識

#### 改善内容
- **文脈考慮パターンの導入**
  ```python
  # 「〜中の」「〜との」「〜への」の後の人名を正しく抽出
  r'(?:^|[、。\s]|展開中の|との|への|による)([ぁ-ん一-龥]{2,6})(?:さん|様|氏)'
  ```
- **フィルタリング条件の追加**: 除外語句と長さ制限（2-6文字）
- **結果**: 「嶋村さんへの導入内容」という自然なタイトルが生成されるように

### 2. 要約機能の項目数不足問題 (2025-06-21)

#### 問題の詳細
- **現象**: 要約が短すぎる（1-2項目のみ）
- **要求**: 箇条書きで3〜6個程度の項目にまとめたい
- **原因**: 最小保証なし、固定上限5個

#### 改善内容
- **動的な項目数調整機能の実装**
  - 最小3個を保証する補強ロジック
  - 最大6個に拡張
  - コンテンツに応じた補強ポイントの自動追加
- **補強ポイントの分類**
  - 会議・コミュニケーション系
  - アクション・提案系
  - 問題解決系

### 3. AppleScriptのボタン制限エラー (2025-06-21)

#### 問題の詳細
- **現象**: 「最大で3つのボタンを使用できます」エラー
- **原因**: 編集機能拡張で4つのボタンを設定してしまった
- **制約**: AppleScriptのdisplay dialogは最大3ボタンまで

#### 改善内容
- **階層化UI設計の採用**
  ```applescript
  -- メインダイアログ (3ボタン)
  buttons {"キャンセル", "編集", "Obsidianに送信"}
  
  -- 編集サブダイアログ (3ボタン)
  buttons {"キャンセル", "プレビュー編集", "原文編集"}
  ```
- **結果**: 制約準拠、機能保持、認知負荷軽減、拡張性確保

### 4. Obsidian保存時の箇条書き欠落問題 (2025-06-21)

#### 問題の詳細
- **現象**: 確認画面では箇条書きが表示されるが、Obsidianに保存されない
- **原因**: 保存関数が要約・箇条書きデータを受け取っていない

#### 改善内容（推奨）
- **_save_memo_fileの引数拡張**
- **save_memoでsummaryデータを渡す**
- **_build_markdown_contentで要約セクションを追加**

### 5. カテゴリ分類の誤判定問題 (2025-06-20)

#### 問題の詳細
- **音楽理論の誤分類**: 「ディミニッシュスケール」等が教育カテゴリに
- **ビジネス利用の誤分類**: ChatGPTのコンサル活用が教育カテゴリに
- **関連ファイル検索の不具合**: 英語キーワードが無視される

#### 改善内容
- **音楽カテゴリの追加**: 音楽理論専用キーワードの定義
- **カタカナ→英語変換辞書**: 音声入力対応
- **関連ファイル検索の改善**
  - 英語対応強化
  - 重要キーワードボーナス
  - 閾値の大幅緩和

### 6. ビジネス優先分類機能の実装 (2025-06-21)

#### 要求仕様
- 個人との打ち合わせは基本的にbusiness（Consulting）に分類
- 「コンサル」「AI」などが含まれた場合はEducation以外を優先

#### 実装内容
- **個人打ち合わせ判定パターン**
- **ビジネス優先キーワード判定**
- **判定の優先順位設定**

## 🛠️ 共通の改善パターン

### 1. 正規表現の改善
- **貪欲マッチングの回避**: 文脈を考慮した限定的なパターン
- **長さ制限の追加**: 不適切に長い文字列のマッチを防ぐ
- **除外パターンの定義**: 誤マッチを防ぐフィルタリング

### 2. 出力制御の改善
- **最小・最大値の設定**: ユーザー期待値に合わせた制御
- **動的調整機能**: コンテンツに応じた柔軟な出力
- **デフォルト値の設定**: 情報不足時の補完

### 3. プラットフォーム制約への対応
- **制約チェックリスト**: 事前確認の徹底
- **階層化設計**: 制約内での機能実現
- **グレースフルデグラデーション**: エラー時の適切な処理

### 4. データフローの一貫性
- **関数シグネチャの統一**: 機能拡張時の追従
- **データ構造の整合性**: プレビューと保存の一致
- **テストの充実**: エンドツーエンドの動作確認

## 📈 今後の改善方針

### 1. 開発プロセスの改善
- **段階的テスト**: 機能追加時の統合確認
- **制約確認**: プラットフォーム固有制限の事前チェック
- **ドキュメント化**: 問題と解決策の記録

### 2. システム設計の改善
- **モジュール化**: 機能の疎結合と高凝集
- **エラーハンドリング**: 予期しない入力への対応
- **拡張性**: 将来の機能追加を見据えた設計

### 3. 品質保証の強化
- **自動テスト**: 回帰テストの充実
- **境界値テスト**: エッジケースの検証
- **パフォーマンステスト**: 大量データでの動作確認

## 🎯 学習ポイント

1. **Ultra Thinking分析の有効性**: 表面的な症状ではなく根本原因を特定
2. **制約を資源化**: プラットフォーム制限を設計の指針に活用
3. **ユーザー中心設計**: 認知負荷の最小化と直感的な操作
4. **段階的改善**: 完璧を求めず、継続的な改善を重視

## 📝 まとめ

これらの改善履歴から、以下の重要な教訓が得られました：

1. **正規表現は慎重に**: 貪欲マッチングに注意し、文脈を考慮する
2. **プラットフォーム制約を事前確認**: AppleScriptの3ボタン制限など
3. **データフローの一貫性を保つ**: 機能追加時は全体への影響を確認
4. **ユーザー期待値を明確に**: 最小・最大値の設定など
5. **テストの充実**: 単体テストだけでなく統合テストも重要

これらの知見を活かし、今後も継続的な改善を進めていきます。